<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qui√©n Quiere Ser Enfermero</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* CSS (sin cambios) */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500&display=swap');
        :root{--main-blue:#02022d;--dark-blue:#0c0c4c;--light-blue:#1e3a8a;--gold:#ffd700;--orange-select:#f9a825;--green-correct:#28a745;--red-incorrect:#dc3545;}
        html, body { height: 100%; margin: 0; }
        body{font-family:'Roboto',sans-serif;background:radial-gradient(circle, var(--light-blue) 0%, var(--main-blue) 70%);color:#fff;display:flex;justify-content:center;align-items:center;overflow:hidden;}
        .game-container{width:100%;height:100%;background:rgba(0,0,0,0.2);text-align:center;position:relative;display:flex;justify-content:center;align-items:center;}
        .screen{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity 0.5s ease;background:radial-gradient(circle, var(--light-blue) 0%, var(--main-blue) 70%);z-index:10;padding: 15px; box-sizing: border-box;}
        .screen.active{opacity:1;visibility:visible;}
        #intro-screen{z-index:20; background:black; padding: 0;}
        #intro-video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover; z-index: 21;}
        #start-overlay{position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:22; display:flex; justify-content:center; align-items:center; cursor:pointer;}
        .btn{font-family:'Orbitron',sans-serif;background:linear-gradient(135deg, var(--gold), var(--orange-select));color:var(--main-blue);border:none;padding:15px 30px;font-size:clamp(1rem, 4vw, 1.2rem);font-weight:700;border-radius:50px;cursor:pointer;transition:all 0.3s ease;margin-top:20px;box-shadow:0 4px 15px rgba(255,215,0,0.3);z-index:1;}
        .btn:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 6px 20px rgba(255,215,0,0.5);}
        .btn:disabled{background:#999;cursor:not-allowed;}
        #welcome-screen h1,#end-screen h2{font-family:'Orbitron',sans-serif;font-size:clamp(2rem, 8vw, 3rem);color:var(--gold);text-shadow:0 0 10px var(--gold);z-index:1; margin: 10px 0;}
        #welcome-screen h1 span{display:block;}
        #welcome-screen form{width:90%;max-width:500px;}
        .welcome-input{display:block;width:100%;box-sizing:border-box;margin:15px auto;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:1rem;}
        #game-screen-wrapper{background:none;}
        #game-screen{width:100%;height:100%;display:grid;box-sizing:border-box; grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "prize" "logo" "qa"; gap: 10px; }
        #logo-container{grid-area:logo;display:flex;justify-content:center;align-items:center;}
        #logo-container img{width:auto;max-width:60%;max-height:10vh;object-fit:contain;}
        #qa-container{grid-area:qa;display:flex;flex-direction:column;justify-content:space-evenly;align-items:center; min-height: 0;}
        #prize-ladder{grid-area:prize;background:rgba(0,0,0,0.4);border-radius:10px;padding:5px;}
        #prize-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:row;justify-content:center;gap:5px;height:100%;}
        #prize-list li{flex-grow:1;display:flex;align-items:center;justify-content:center;padding:5px;font-family:'Orbitron',sans-serif;color:rgba(255,255,255,0.7);transition:all 0.3s ease;border-radius:5px; font-size: 0.7rem; white-space: nowrap;}
        #prize-list li.current{background-color:var(--orange-select);color:var(--main-blue);font-weight:700;transform:scale(1.1);box-shadow:0 0 15px var(--orange-select);}
        #prize-list li span:first-child{color:var(--gold);margin-right:5px;}
        #level-title{font-family:'Orbitron',sans-serif;font-size:clamp(1.2rem, 5vw, 1.8rem);color:var(--gold);margin: 10px 0;text-shadow:0 0 8px var(--gold);}
        #question-box{width:95%;height:auto;min-height:80px;background:linear-gradient(180deg, var(--main-blue), var(--dark-blue));border:2px solid var(--gold);border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:clamp(1rem, 4vw, 1.4rem);padding:15px;margin-bottom:15px;clip-path:polygon(0% 50%, 5% 0%, 95% 0%, 100% 50%, 95% 100%, 5% 100%);}
        #options-grid{width:95%;display:grid;grid-template-columns:1fr;gap:10px;}
        .option-box{background:linear-gradient(180deg, var(--main-blue), var(--dark-blue));border:2px solid var(--gold);color:#fff;font-size:clamp(0.9rem, 3.5vw, 1.2rem);border-radius:10px;cursor:pointer;transition:all 0.2s ease;text-align:left;padding:12px 20px;clip-path:polygon(0% 50%, 8% 0%, 92% 0%, 100% 50%, 92% 100%, 8% 100%);}
        #lives-display{position:absolute;top:15px;left:15px;font-size:1.2rem;font-family:'Orbitron';}
        #lives-display span{font-size:1.5rem;margin-left:5px;color:var(--red-incorrect);text-shadow:0 0 5px var(--red-incorrect);}
        @media (min-width: 768px) { #game-screen { grid-template-columns: 1fr 250px; grid-template-rows: 120px 1fr; grid-template-areas: "logo prize" "qa   prize"; gap: 20px; padding: 20px; } #qa-container { justify-content: center; } #logo-container img { max-height: 100px; max-width: 80%; } #prize-list { flex-direction:column-reverse; gap:0;} #prize-list li { padding: 0 15px; font-size: 1rem; justify-content: flex-start;} #prize-list li span:first-child { margin-right: 15px; } #options-grid { grid-template-columns: 1fr 1fr; gap:15px; } }
        .option-box:hover{background:var(--light-blue);}.option-prefix{color:var(--orange-select);font-family:'Orbitron',sans-serif;margin-right:15px;}.option-box.selected{background:var(--orange-select);color:var(--main-blue);font-weight:bold;animation:pulse-select 1.2s infinite;}.option-box.correct{background:var(--green-correct);animation:flash-correct 1s;}.option-box.incorrect{background:var(--red-incorrect);animation:shake-incorrect 0.5s;}@keyframes pulse-select{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}@keyframes flash-correct{0%,100%{opacity:1;}50%{opacity:0.3;}}@keyframes shake-incorrect{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-8px);}20%,40%,60%,80%{transform:translateX(8px);}}
        #leaderboard-container{margin-top:20px;width:90%;max-width:600px;text-align:left;}#leaderboard-list{list-style:none;padding:0;}#leaderboard-list li{background:rgba(0,0,0,0.3);padding:10px 15px;border-radius:5px;margin-bottom:8px;display:flex;justify-content:space-between;font-weight:500; font-size: clamp(0.8rem, 3vw, 1rem);}#leaderboard-list li.current-player{background:var(--gold);color:var(--main-blue);font-weight:700;}#final-rank{font-size:clamp(1rem, 4vw, 1.3rem);color:var(--gold);margin-top:5px;font-weight:700;}
    </style>
</head>
<body>
    <div class="game-container">
        <div id="intro-screen" class="screen active"> <div id="start-overlay"><button class="btn">Hacer Clic para Empezar</button></div> <video id="intro-video" src="https://somnozzz.cl/wp-content/uploads/2025/06/QQSM.mp4" muted playsinline></video> </div>
        <div id="welcome-screen" class="screen"><h1>QUI√âN QUIERE SER<br><span>ENFERMERO</span></h1><p>Ingresa tus datos para comenzar. Tienes 3 intentos.</p><form id="register-form"><input type="text" id="player-name" class="welcome-input" placeholder="Tu Nombre y Apellido" required><input type="text" id="player-service" class="welcome-input" placeholder="Tu Servicio / √Årea de Trabajo" required><button type="submit" id="start-btn" class="btn">¬°Comenzar a Jugar!</button></form></div>
        <div id="game-screen-wrapper" class="screen"> <div id="lives-display"></div> <div id="game-screen"> <div id="logo-container"><img src="https://somnozzz.cl/wp-content/uploads/2025/06/QQSM.png" alt="Logo del Juego"></div> <div id="qa-container"><h2 id="level-title"></h2><div id="question-box"></div><div id="options-grid"></div></div> <div id="prize-ladder"><ol id="prize-list" reversed></ol></div> </div> </div>
        <div id="end-screen" class="screen"> <h2 id="end-message"></h2> <p id="final-score"></p> <p id="final-rank"></p> <div id="leaderboard-container"> <h2>üèÜ Top 10 Jugadores üèÜ</h2> <ol id="leaderboard-list"></ol> <button id="restart-btn" class="btn">Jugar de Nuevo</button> </div> </div>
    </div>
    <audio id="intro-sound" src="https://somnozzz.cl/wp-content/uploads/2025/06/Pregunta-Quien-quiere-ser-millonario_-Sound-Effect.mp3" preload="auto"></audio><audio id="question-start-sound" src="https://www.myinstants.com/media/sounds/empezar-pregunta-quien-quiere-ser-millonario.mp3" preload="auto"></audio><audio id="background-music" src="https://somnozzz.cl/wp-content/uploads/2025/06/Quien-Quiere-Ser-Millonario-Efecto-de-Sonido.mp3" preload="auto" loop></audio><audio id="correct-sound" src="https://www.myinstants.com/media/sounds/es-correcto.mp3" preload="auto"></audio><audio id="incorrect-sound" src="https://www.myinstants.com/media/sounds/sonido-de-error-de-windows-xp-fatal-error.mp3" preload="auto"></audio>

    <script>
        // --> URL DEFINITIVA INTEGRADA <--
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCKsjvfq6yPEMfLoFgQmTmOUVaYaLFVj2RJTYLVOnU0El9fIoK-hNs4PDTLXJlOFCc/exec";

        // --> BANCO DE PREGUNTAS CORREGIDO Y VERIFICADO MANUALMENTE <--
        const FULL_QUESTION_BANK = [
            // I. DRENAJE TOR√ÅCICO Y PLEUROSTOM√çA
            { question: "¬øCu√°l es la raz√≥n fisiol√≥gica principal para colocar una pleurostom√≠a en el 5¬∞ espacio intercostal, l√≠nea medio axilar?", options: ["Es la zona m√°s pr√≥xima al diafragma.", "Facilitar la movilizaci√≥n del paciente.", "Corresponde a una zona segura y accesible con menor riesgo de da√±ar estructuras vasculares.", "Mejora la adherencia pulmonar."], correct: 2 },
            { question: "¬øQu√© elemento debe verificarse de forma continua en un sistema de drenaje con sello de agua?", options: ["La presencia de burbujas persistentes en la c√°mara de succi√≥n.", "El nivel de oxigenaci√≥n del paciente.", "La fluctuaci√≥n (swinging) en la columna de agua del sello.", "El color del tubo de drenaje."], correct: 2 },
            { question: "¬øCu√°l es una indicaci√≥n cl√≠nica para sospechar una fuga a√©rea persistente en un paciente con pleurostom√≠a?", options: ["Aumento de la presi√≥n venosa central.", "Dolor tor√°cico durante la inspiraci√≥n.", "Presencia constante de burbujeo en el sello de agua durante la espiraci√≥n.", "Disminuci√≥n del gasto urinario."], correct: 2 },
            { question: "¬øCu√°l es el principal riesgo de aplicar una presi√≥n negativa excesiva en un sistema de drenaje tor√°cico?", options: ["Desplazamiento del tubo de drenaje.", "Infecci√≥n del sitio de inserci√≥n.", "Colapso del pulm√≥n contralateral.", "Lesi√≥n al tejido pulmonar por succi√≥n excesiva."], correct: 3 },
            { question: "¬øQu√© caracter√≠stica distingue un sello seco de un sello de agua en los sistemas de drenaje tor√°cico?", options: ["Requiere cambio diario.", "No permite la movilizaci√≥n del paciente.", "No necesita columna l√≠quida para funcionar como v√°lvula antirretorno.", "Es menos efectivo en neumot√≥rax."], correct: 2 },
            { question: "¬øCu√°l es un beneficio cl√≠nico documentado de la movilizaci√≥n temprana en pacientes con pleurostom√≠a?", options: ["Previene la acumulaci√≥n de secreciones en el tubo.", "Aumenta la duraci√≥n del uso del tubo tor√°cico.", "Mejora la reexpansi√≥n pulmonar y la funci√≥n respiratoria.", "Evita el uso de antibi√≥ticos profil√°cticos."], correct: 2 },
            { question: "¬øQu√© criterio es necesario cumplir antes de retirar un tubo de pleurostom√≠a?", options: ["Disminuci√≥n del dolor tor√°cico.", "Ausencia de burbujeo y menos de 200 ml de drenaje en 24 horas.", "Saturaci√≥n de ox√≠geno superior al 90%.", "Ausencia de secreciones en el tubo."], correct: 1 },
            { question: "¬øCu√°l es la presi√≥n negativa est√°ndar recomendada para el sistema de succi√≥n continua en una pleurostom√≠a?", options: ["-10 cmH‚ÇÇO", "-20 cmH‚ÇÇO", "-30 cmH‚ÇÇO", "-40 cmH‚ÇÇO"], correct: 1 },
            // II. SEDOANALGESIA Y FARMACOLOG√çA
            { question: "¬øQu√© factor farmacocin√©tico del propofol justifica su suspensi√≥n antes de realizar pruebas neurol√≥gicas en pacientes ventilados?", options: ["Su metabolismo renal y acumulaci√≥n en caso de falla renal.", "Su larga vida media terminal y acumulaci√≥n tisular.", "Su acci√≥n sobre los receptores GABA-A.", "Su interacci√≥n con la noradrenalina en perfusi√≥n."], correct: 1 },
            { question: "¬øQu√© combinaci√≥n de drogas vasoactivas se considera segura en la misma l√≠nea Y, siempre que se usa soluci√≥n salina como diluyente?", options: ["Noradrenalina y dopamina.", "Adrenalina y bicarbonato de sodio.", "Dobutamina y midazolam.", "Propofol y noradrenalina."], correct: 0 },
            { question: "¬øCu√°l de los siguientes f√°rmacos utilizados en sedoanalgesia puede inducir s√≠ndrome de infusi√≥n prolongada si se usa m√°s all√° de 48 horas a dosis altas?", options: ["Fentanilo", "Propofol", "Midazolam", "Ketamina"], correct: 1 },
            { question: "Paciente adulto de 72 kg, con fiebre persistente postoperatoria, requiere manejo antipir√©tico y se indica paracetamol IV. ¬øCu√°l es una precauci√≥n clave al administrar paracetamol endovenoso?", options: ["Se debe diluir en 100 ml de soluci√≥n salina y administrar en bolo r√°pido.", "La infusi√≥n debe completarse en no menos de 15 minutos para evitar hipotensi√≥n.", "Solo puede administrarse por v√≠a subcut√°nea o intramuscular.", "No debe administrarse en pacientes con fiebre posoperatoria por riesgo de hepatotoxicidad."], correct: 1 },
            // III. ACCESOS VASCULARES
            { question: "En un paciente con shock hipovol√©mico, se requiere infundir soluciones hipert√≥nicas y aminas vasoactivas. ¬øCu√°l de las siguientes afirmaciones es correcta respecto al tipo de acceso?", options: ["Puede utilizarse un cat√©ter perif√©rico por 72 horas sin riesgo.", "Se debe insertar un acceso subcut√°neo con bomba elastom√©rica.", "El uso de cat√©ter venoso central es obligatorio por pH y osmolaridad.", "El midline es suficiente si se rotan los sitios cada 24 horas."], correct: 2 },
            { question: "Paciente con tratamiento antibi√≥tico de largo plazo recibe vancomicina (pH 2,8, infusi√≥n continua). Tiene mala red venosa perif√©rica y requiere infusi√≥n por m√°s de 7 d√≠as. ¬øQu√© cat√©ter es el m√°s indicado?", options: ["Cat√©ter venoso perif√©rico.", "L√≠nea media.", "Cat√©ter venoso central tipo PICC.", "Cat√©ter de hemodi√°lisis."], correct: 2 },
            { question: "¬øCu√°l de las siguientes caracter√≠sticas distingue al cat√©ter midline respecto del PICC en cuanto a ubicaci√≥n anat√≥mica de la punta?", options: ["Ambos terminan en la vena cava superior.", "El midline finaliza en el tercio distal de la vena bas√≠lica o cef√°lica, sin llegar a la cava.", "El PICC se inserta en venas perif√©ricas pero finaliza en aur√≠cula derecha.", "El midline se inserta solo en la yugular externa."], correct: 1 },
            { question: "En un paciente con requerimiento de infusi√≥n de noradrenalina por m√°s de 48 horas, ¬øcu√°l es el acceso vascular m√°s seguro y apropiado?", options: ["Cat√©ter venoso perif√©rico de grueso calibre.", "Cat√©ter l√≠nea media.", "Cat√©ter venoso central o PICC con lumen exclusivo.", "Cat√©ter arterial."], correct: 2 },
            { question: "¬øCu√°l de las acciones es cr√≠tica antes de utilizar un cat√©ter PICC reci√©n instalado para infusi√≥n continua?", options: ["Irrigar con 20 ml de soluci√≥n salina.", "Confirmar posici√≥n de la punta mediante t√©cnica de ECG intracavitario o imagen radiol√≥gica.", "Lavar con heparina y comenzar la infusi√≥n de inmediato.", "Retirar el ap√≥sito inicial y aplicar uno transparente."], correct: 1 },
            { question: "¬øQu√© criterio contraindica el uso de cat√©ter midline en un paciente hospitalizado?", options: ["Necesidad de antibi√≥ticos intravenosos por 7 d√≠as.", "Requiere infusi√≥n de soluciones con osmolaridad > 900 mOsm/L.", "No tiene accesos venosos perif√©ricos visibles.", "Es al√©rgico a la clorhexidina."], correct: 1 },
            { question: "¬øCu√°l es la complicaci√≥n m√°s frecuente asociada a la inserci√≥n de un cat√©ter venoso central en la vena subclavia?", options: ["Flebitis localizada.", "Neumot√≥rax.", "Oclusi√≥n de l√≠nea por precipitaci√≥n.", "Trombosis venosa profunda en extremidad inferior."], correct: 1 },
            // IV. SONDAJE VESICAL
            { question: "En un paciente con antecedente de hiperplasia prost√°tica benigna y episodios de retenci√≥n urinaria, ¬øcu√°l es el factor cl√≠nico m√°s determinante para optar por una sonda intermitente en lugar de uno permanente?", options: ["Mayor comodidad del paciente.", "Menor riesgo de infecci√≥n urinaria.", "Capacidad para realizar autocateterismo y funci√≥n vesical conservada.", "Presencia de hematuria persistente."], correct: 2 },
            { question: "¬øCu√°l es la raz√≥n fisiopatol√≥gica por la que se desaconseja el uso prolongado de cat√©ter urinario permanente sin indicaci√≥n estricta?", options: ["Aumenta la presi√≥n intravesical provocando reflujo vesicoureteral.", "Disminuye el tono del detrusor por desuso prolongado.", "Genera alcalinizaci√≥n urinaria progresiva.", "Conduce a una hiponatremia secundaria a p√©rdida urinaria."], correct: 1 },
            { question: "En un paciente con cat√©ter urinario permanente, ¬øqu√© condici√≥n indicar√≠a una obstrucci√≥n por incrustaci√≥n cr√≥nica del cat√©ter?", options: ["Diuresis aumentada y orina clara.", "Orina con sangre visible y fiebre s√∫bita.", "Dificultad para drenar orina pese a posici√≥n correcta y dolor suprap√∫bico.", "Hipertensi√≥n asociada a retenci√≥n urinaria."], correct: 2 },
            { question: "¬øCu√°l es el principio microbiol√≥gico que justifica la estricta adherencia a un sistema cerrado en el manejo del cat√©ter urinario permanente?", options: ["Evita el ingreso de bacterias por v√≠a hemat√≥gena.", "Previene la colonizaci√≥n bacteriana ascendente por manipulaci√≥n externa.", "Disminuye la excreci√≥n de amonio en orina alcalina.", "Impide la formaci√≥n de biofilm en el meato urinario."], correct: 1 },
            // V. PREVENCI√ìN Y CONTROL DE INFECCIONES (IAAS)
            { question: "¬øCu√°l es el objetivo principal de un programa de vigilancia epidemiol√≥gica del IAAS?", options: ["Reducir los costos hospitalarios.", "Identificar, controlar y prevenir infecciones asociadas a la atenci√≥n sanitaria.", "Cumplir con requisitos legales √∫nicamente.", "Mejorar la satisfacci√≥n del usuario."], correct: 1 },
            { question: "Ante un brote de infecci√≥n por microorganismo multirresistente, la primera acci√≥n de la enfermera de control de infecciones debe ser:", options: ["Informar a los familiares de los pacientes afectados.", "Suspender las cirug√≠as programadas.", "Implementar precauciones de aislamiento y notificar al equipo de control de infecciones.", "Cambiar todos los equipos m√©dicos del servicio."], correct: 2 },
            { question: "¬øCu√°l es la frecuencia m√≠nima recomendada para la higiene de manos en el personal de salud?", options: ["Al inicio y final del turno.", "Antes y despu√©s del contacto con cada paciente.", "Solo cuando las manos est√°n visiblemente sucias.", "Cada 2 horas durante el turno."], correct: 1 },
            { question: "Los medidas de intervenciones de prevenci√≥n de IAAS se caracterizan por:", options: ["Ser medidas individuales aplicadas por separado.", "Conjunto de intervenciones basadas en evidencia aplicadas de forma integral.", "Protocolos opcionales seg√∫n criterio del personal.", "Medidas aplicadas solo en pacientes de alto riesgo."], correct: 1 },
            { question: "El indicador m√°s importante para evaluar la efectividad de un programa de control de IAAS es:", options: ["N√∫mero de capacitaciones realizadas.", "Cantidad de insumos de higiene consumidos.", "Tasa de incidencia de infecciones asociadas a la atenci√≥n sanitaria.", "Tiempo promedio de hospitalizaci√≥n."], correct: 2 },
            { question: "¬øCu√°ndo se debe implementar aislamiento por contacto?", options: ["Solo en pacientes con fiebre.", "En infecciones por microorganismos multirresistentes y pat√≥genos transmitidos por contacto.", "√önicamente en unidades de cuidados intensivos.", "Solo si el paciente lo solicita."], correct: 1 },
            { question: "El EPP (Elementos de Protecci√≥n Personal) para precauciones por contacto incluye:", options: ["Solo guantes.", "Guantes, bata y protecci√≥n ocular siempre.", "Guantes y bata como m√≠nimo, mascarilla seg√∫n evaluaci√≥n del riesgo.", "√önicamente mascarilla N95."], correct: 2 },
            { question: "En aislamiento respiratorio por gotas, el EPP indispensable es:", options: ["Mascarilla quir√∫rgica, guantes y protecci√≥n ocular.", "Solo mascarilla N95.", "Guantes y bata √∫nicamente.", "Protecci√≥n completa con traje impermeable."], correct: 0 },
            // VI. ESTRATEGIA HOSPITAL AMIGO Y ACREDITACI√ìN
            { question: "¬øCu√°l es el objetivo principal de la estrategia Hospital Amigo?", options: ["Reducir los costos operativos del hospital.", "Impulsar la apertura de los establecimientos de salud a la familia y comunidad.", "Aumentar el n√∫mero de camas disponibles.", "Mejorar √∫nicamente la infraestructura hospitalaria."], correct: 1 },
            { question: "La estrategia Hospital Amigo se implementa en Chile desde:", options: ["2003", "2006", "2010", "2015"], correct: 1 },
            { question: "¬øCu√°l es una de las caracter√≠sticas principales de un Hospital Amigo?", options: ["Horarios de visita restringidos √∫nicamente en horarios de oficina.", "Atenci√≥n humanizada, acogedora y participativa hacia los usuarios.", "Prohibici√≥n de acompa√±antes durante la hospitalizaci√≥n.", "Atenci√≥n exclusiva para pacientes privados."], correct: 1 },
            { question: "¬øC√≥mo se eval√∫a si un hospital cumple con los est√°ndares de Hospital Amigo?", options: ["Mediante encuestas solo a los funcionarios.", "A trav√©s de una pauta de chequeo aplicada peri√≥dicamente.", "Solo por la satisfacci√≥n financiera del establecimiento.", "√önicamente por la cantidad de pacientes atendidos."], correct: 1 },
            { question: "¬øCu√°l es el enfoque principal de la estrategia Hospital Amigo en relaci√≥n a la familia?", options: ["Limitar la participaci√≥n familiar en el cuidado del paciente.", "Fortalecer la relaci√≥n del equipo de salud con usuarios y familias.", "Cobrar por las visitas familiares.", "Permitir visitas solo los fines de semana."], correct: 1 },
            { question: "¬øQu√© es la acreditaci√≥n de prestadores institucionales de salud en Chile?", options: ["Un proceso de evaluaci√≥n opcional para mejorar la infraestructura.", "Un proceso peri√≥dico de evaluaci√≥n para verificar el cumplimiento de los est√°ndares de calidad establecidos por el Ministerio de Salud.", "Una certificaci√≥n √∫nicamente para hospitales privados.", "Un tr√°mite administrativo para obtener permisos municipales."], correct: 1 },
            { question: "¬øCu√°l es la vigencia de la acreditaci√≥n para prestadores institucionales?", options: ["1 a√±o", "2 a√±os", "3 a√±os", "5 a√±os"], correct: 2 },
            { question: "¬øQu√© instituci√≥n fiscaliza a las Entidades Acreditadoras en Chile?", options: ["Ministerio de Salud.", "Superintendencia de Salud.", "FONASA.", "Servicio de Salud correspondiente."], correct: 1 },
            { question: "¬øQu√© tipo de prestadores pueden someterse al proceso de acreditaci√≥n?", options: ["Solo hospitales p√∫blicos.", "√önicamente cl√≠nicas privadas.", "Hospitales, cl√≠nicas, centros ambulatorios y laboratorios autorizados por la Autoridad Sanitaria.", "Solo centros de atenci√≥n primaria."], correct: 2 },
            { question: "¬øCu√°l es el car√°cter del proceso de acreditaci√≥n en Chile actualmente?", options: ["Obligatorio para todos los prestadores.", "Voluntario para los prestadores institucionales.", "Obligatorio solo para hospitales p√∫blicos.", "Obligatorio solo para prestadores privados."], correct: 1 },
            { question: "En el proceso de acreditaci√≥n para prestadores de atenci√≥n cerrada, ¬øcu√°l es el costo establecido para hospitales de alta complejidad seg√∫n los est√°ndares vigentes?", options: ["150 UTM", "200 UTM", "300 UTM", "500 UTM"], correct: 2 },
            { question: "¬øCu√°l es el requisito previo fundamental que debe cumplir un prestador institucional de atenci√≥n cerrada antes de solicitar el proceso de acreditaci√≥n?", options: ["Tener convenio con FONASA.", "Haber ejecutado y concluido el proceso de autoevaluaci√≥n.", "Contar con certificaci√≥n ISO.", "Tener m√°s de 100 camas."], correct: 1 },
            // VII. PREVENCI√ìN DE LESIONES POR PRESI√ìN
            { question: "Seg√∫n la Orientaci√≥n T√©cnica para la Prevenci√≥n de Lesiones por Presi√≥n, MINSAL 2023, ¬øcu√°l es la intervenci√≥n m√°s efectiva para pacientes con movilidad limitada y alto riesgo seg√∫n Braden?", options: ["Colch√≥n de agua sin reposicionamiento frecuente.", "Almohadas de algod√≥n en prominencias √≥seas.", "Reposicionamiento cada 2 horas y superficie especial de redistribuci√≥n de presi√≥n.", "Cremas antibi√≥ticas en sacro cada 4 horas."], correct: 2 },
            { question: "De acuerdo con la Orientaci√≥n T√©cnica MINSAL 2023, ¬øcu√°ndo se justifica el uso de superficies de alta tecnolog√≠a para redistribuci√≥n de presi√≥n?", options: ["Lesi√≥n grado 1 en extremidades.", "Solo p√©rdida de sensibilidad t√°ctil.", "M√∫ltiples factores de riesgo y lesi√≥n grado 3 o mayor.", "Cuidados paliativos sin lesi√≥n visible."], correct: 2 },
            { question: "Seg√∫n la Orientaci√≥n T√©cnica del MINSAL 2023, ¬øqu√© aspecto gu√≠a las intervenciones preventivas de enfermer√≠a?", options: ["Edad del paciente.", "Tiempo de hospitalizaci√≥n.", "Escala Braden y observaci√≥n cl√≠nica.", "Preferencia por materiales de cama."], correct: 2 },
            { question: "¬øQu√© rol asigna la Orientaci√≥n T√©cnica MINSAL 2023 al personal de enfermer√≠a en prevenci√≥n de lesiones por presi√≥n?", options: ["Cambios de posici√≥n solo con lesiones activas.", "Aplicar ap√≥sitos solo bajo orden m√©dica.", "Implementar medidas preventivas y liderar educaci√≥n al equipo.", "Supervisar limpieza de colchones."], correct: 2 },
            { question: "¬øCu√°l es la frecuencia m√≠nima de reposicionamiento en UCI, seg√∫n la Orientaci√≥n T√©cnica MINSAL 2023?", options: ["Cada 1 hora.", "Cada 4 horas.", "Cada 2 horas con evaluaci√≥n cut√°nea.", "Solo al cambio de turno."], correct: 2 },
            // VIII. MARCO LEGAL Y BENEFICIOS
            { question: "Una enfermera del servicio de medicina realiza turnos exclusivamente diurnos, pero ocasionalmente cubre reemplazos nocturnos en la UTI. ¬øPuede acceder a la asignaci√≥n de la Ley 19.264?", options: ["S√≠, si realiza al menos un turno nocturno al mes.", "No, ya que su destino principal no es una unidad cerrada ni en turno rotativo formal.", "S√≠, autom√°ticamente por estar en hospital de alta complejidad.", "Solo si firma una carta de compromiso adicional."], correct: 1 },
            { question: "¬øCu√°l es la finalidad del descanso compensatorio especial de 10 d√≠as h√°biles anuales para los profesionales regulados por la Ley 19.264?", options: ["Sustituir el feriado legal de 15 d√≠as h√°biles.", "Compensar el desgaste f√≠sico y ps√≠quico por turnos rotativos en unidades cr√≠ticas.", "Otorgar tiempo para capacitaci√≥n continua obligatoria.", "Reemplazar el descanso postnatal parental en profesionales varones."], correct: 1 },
            { question: "¬øCu√°l es la consecuencia establecida por la Ley 19.536 para un profesional beneficiario que es sancionado disciplinariamente durante el per√≠odo de compensaci√≥n?", options: ["Se le suspender√° el pago del beneficio por tres meses.", "Pierde el derecho a recibir la compensaci√≥n desde la fecha de aplicaci√≥n de la sanci√≥n y por el resto del per√≠odo vigente.", "Deber√° devolver las bonificaciones recibidas anteriormente.", "Se le traslada a otra unidad sin bonificaci√≥n."], correct: 1 },
            { question: "Seg√∫n la Ley 19.536, ¬øcu√°l es uno de los principales objetivos de otorgar esta calificaci√≥n al personal de salud?", options: ["Compensar econ√≥micamente la escasez de recursos f√≠sicos en unidades cr√≠ticas.", "Reforzar la estabilidad contractual en establecimientos rurales.", "Reconocer el trabajo en unidades de mayor complejidad y rotaci√≥n, como UCI, Neonatolog√≠a y Pabell√≥n.", "Sustituir los bonos por desempe√±o institucional."], correct: 2 },
            // IX. PROBIDAD ADMINISTRATIVA Y ESTATUTO ADMINISTRATIVO
            { question: "¬øCu√°l de las siguientes situaciones constituye una vulneraci√≥n directa al principio de probidad administrativa en un funcionario p√∫blico de salud?", options: ["No asistir a una capacitaci√≥n voluntaria fuera del horario laboral.", "Aceptar un obsequio de un familiar de un paciente como agradecimiento por la atenci√≥n.", "Tomar una pausa para colaci√≥n en el horario establecido.", "Informar al equipo m√©dico sobre un error en la prescripci√≥n de medicamentos."], correct: 1 },
            { question: "Un encargado de calidad en un hospital modifica los datos de cumplimiento de indicadores asistenciales para que el servicio aparezca con un rendimiento superior al real. ¬øQu√© infracci√≥n se configura seg√∫n el Estatuto Administrativo?", options: ["Optimizaci√≥n de datos para resguardar la imagen institucional.", "Faltas menores por ajustes metodol√≥gicos.", "Manipulaci√≥n de informaci√≥n oficial, constituyendo una falta grave a la probidad administrativa.", "Acci√≥n v√°lida si es autorizada verbalmente por la jefatura."], correct: 2 },
            { question: "Una enfermera jefe de pabell√≥n autoriza reiteradamente la compra de insumos a una empresa en la que trabaja su cu√±ado, sin participar directamente en las ventas. ¬øQu√© principio es vulnerable a esta situaci√≥n?", options: ["Principio de eficiencia institucional.", "Derecho a la confidencialidad.", "Principio de probidad por conflicto de interes.", "Principio de legalidad presupuestaria."], correct: 2 },
            { question: "¬øQu√© principio del Estatuto Administrativo debe respetarse al planificar turnos nocturnos y festivos del personal de enfermer√≠a?", options: ["Rotaci√≥n continua sin horario l√≠mite.", "Igualdad en la distribuci√≥n de cargas y respeto al descanso compensatorio.", "Exclusi√≥n de jefaturas del sistema de turnos.", "Prioridad a los funcionarios de mayor antig√ºedad para evitar el desgaste."], correct: 1 },
            { question: "Una enfermera reclama que ha sido reiteradamente asignada a turnos nocturnos, mientras otros colegas no lo son. ¬øQu√© derecho est√° siendo potencialmente vulnerado seg√∫n el Estatuto Administrativo?", options: ["Derecho al descanso materno.", "Derecho a la neutralidad sindical.", "Derecho a la equidad en la planificaci√≥n de turnos y no discriminaci√≥n.", "Derecho a solicitar traslado inmediato."], correct: 2 },
            // X. LEY KARIN
            { question: "Seg√∫n la Ley Karin, ¬øcu√°l es la primera obligaci√≥n del empleador ante una denuncia formal de acoso laboral en un establecimiento de salud p√∫blica?", options: ["Desvincular inmediatamente al denunciado.", "Realizar una mediaci√≥n informal entre las partes.", "Activar el procedimiento interno de investigaci√≥n conforme al reglamento y adoptar medidas de resguardo para la persona denunciante.", "Informar a los sindicatos del caso."], correct: 2 },
            { question: "¬øQu√© medida contempla la Ley Karin para proteger a la persona denunciante durante el proceso investigativo?", options: ["Cambiarla de unidad o servicio, con p√©rdida de asignaciones.", "Suspenderla mientras se realiza la investigaci√≥n.", "Mantener la confidencialidad y evitar represalias durante todo el proceso.", "Pedirle que renuncie temporalmente al cargo."], correct: 2 },
            { question: "En el contexto de la Ley Karin, ¬øcu√°l de los siguientes ejemplos constituye una manifestaci√≥n de acoso laboral reiterado?", options: ["Una correcci√≥n t√©cnica puntual en una reuni√≥n cl√≠nica.", "Una cr√≠tica aislada en tono firme del supervisor.", "Humillaciones repetidas ante colegas que afectan la dignidad del funcionario.", "La entrega de un memor√°ndum con instrucciones administrativas."], correct: 2 },
            // XI. ASENF (ASOCIACI√ìN DE ENFERMERAS/OS)
            { question: "¬øCu√°l es uno de los principales roles de ASENF en la defensa de los derechos laborales de las enfermeras del sector p√∫blico?", options: ["Negociar remuneraciones individualmente con los socios.", "Representar colectivamente a sus afiliadas ante autoridades del MINSAL y Servicios de Salud en casos de vulneraci√≥n de derechos laborales.", "Otorgar certificados de capacitaci√≥n v√°lidos para concursos.", "Dirigir exclusivamente procesos disciplinarios internos."], correct: 1 },
            { question: "¬øC√≥mo puede ASENF intervenir en situaciones de maltrato o acoso laboral hacia una enfermera afiliada?", options: ["Otorgando financiamiento externo para la desvinculaci√≥n.", "Asesorando y acompa√±ando el proceso administrativo y/o judicial, y canalizando denuncias ante entes competentes.", "Permitiendo la renuncia a beneficios laborales para evitar conflictos.", "Sustituyendo al empleador en la gesti√≥n del caso."], correct: 1 },
            { question: "¬øQu√© herramienta gremial puede activar ASENF cuando una unidad hospitalaria presenta turnos inadecuados que vulneran el Estatuto Administrativo?", options: ["Solicitud al ministerio para que modifique la dotaci√≥n.", "Derivaci√≥n directa del caso al Colegio M√©dico.", "Gesti√≥n de denuncias colectivas, fiscalizaci√≥n y solicitud formal de revisi√≥n al Servicio de Salud respectivo.", "Suspensi√≥n de las funciones del jefe de unidad."], correct: 2 },
            { question: "En el contexto de las asignaciones especiales (urgencia, cr√≠tica, etc.), ¬øde qu√© forma ASENF puede contribuir a garantizar su correcta aplicaci√≥n?", options: ["Postulando a los funcionarios directamente.", "Gestionando la resoluci√≥n administrativa de pago.", "Supervisando internamente la unidad donde se aplica.", "Monitoreando y exigiendo el cumplimiento de los criterios normativos mediante representaci√≥n t√©cnica ante directivos locales y nacionales."], correct: 3 },
            // MONITORIZACI√ìN HEMODIN√ÅMICA
            { question: "Al observar la curva de presi√≥n arterial invasiva, se identifica una forma achatada con descenso de la amplitud y una onda d√≠crota poco visible. ¬øCu√°l es la interpretaci√≥n m√°s probable?", options: ["Hipertensi√≥n arterial severa.", "Colapso del sistema respiratorio.", "Subestimaci√≥n de la presi√≥n por amortiguaci√≥n del sistema o presencia de burbujas.", "Hiperresonancia del transductor."], correct: 2 },
            { question: "Una curva arterial con forma exageradamente picuda y oscilaciones post-s√≠stole excesivas (sobreshooting) indica qu√© alteraciones t√©cnica del sistema?", options: ["Hipotensi√≥n severa.", "Resonancia aumentada por un sistema mal amortiguado (hiperdin√°mico).", "Falla del transductor.", "Obstrucci√≥n del cat√©ter arterial."], correct: 1 },
            // ELECTROCARDIOGRAF√çA (ECG)
            { question: "En un ECG trazado de 12 derivaciones, una enfermera identifica una elevaci√≥n del segmento ST en DII, DIII y aVF. ¬øQu√© sospecha cl√≠nica debe priorizar?", options: ["Infarto anterior extenso.", "Isquemia subendoc√°rdica global.", "Infarto agudo de miocardio en cara inferior.", "Bloqueo auriculoventricular de primer grado."], correct: 2 },
            { question: "En un ECG, la presencia de ondas P irregulares, sin morfolog√≠a definida, acompa√±adas de una frecuencia ventricular irregular, sugiere:", options: ["Taquicardia supraventricular parox√≠stica.", "Fibrilaci√≥n auricular.", "Fluter auricular.", "Ritmo nodal."], correct: 1 },
            { question: "¬øQu√© alteraciones electrocardiogr√°ficas es caracter√≠stica de la hiperkalemia severa y debe alertar a la enfermera?", options: ["Ondas T invertidas sim√©tricas.", "Prolongaci√≥n del intervalo QT.", "Ondas T picudas y acuminadas, con desaparici√≥n progresiva de la onda P.", "Bradicardia sinusal con extras√≠stoles."], correct: 2 },
            // TERAPIA TROMBOL√çTICA
            { question: "En un paciente con infarto agudo de miocardio con elevaci√≥n del ST (IAMCEST) que no tiene acceso inmediato a angioplast√≠a, ¬øcu√°l es la ventana de tiempo ideal para administrar tromb√≥lisis seg√∫n las gu√≠as actuales?", options: ["Dentro de las primeras 12 horas desde el inicio de los s√≠ntomas.", "Solo despu√©s de las 24 horas si persiste dolor.", "Hasta 36 horas en cualquier paciente sin importar edad.", "Despu√©s de iniciar antiagregaci√≥n y heparina."], correct: 0 },
            { question: "¬øCu√°l de las siguientes condiciones representa una contraindicaci√≥n absoluta para la tromb√≥lisis en un paciente con sospecha de tromboembolismo pulmonar masivo?", options: ["Hipertensi√≥n arterial controlada.", "Cirug√≠a mayor reciente (√∫ltimos 10 d√≠as).", "Hemorragia intracraneana previa.", "Uso de anticoagulantes orales."], correct: 2 },
            // REANIMACI√ìN CARDIOPULMONAR (RCP) AVANZADA
            { question: "Durante una RCP avanzada, el ritmo en el monitor es fibrilaci√≥n ventricular. ¬øCu√°l es la acci√≥n inmediata indicada seg√∫n el protocolo ACLS?", options: ["Administrar adrenalina y realizar masaje card√≠aco.", "Realizar desfibrilaci√≥n inmediata seguida de compresiones.", "Administrar amiodarona y esperar recuperaci√≥n.", "Colocar marcapasos externos."], correct: 1 },
            { question: "En un paciente intubado durante paro cardiorrespiratorio, ¬øcu√°l es la frecuencia de ventilaci√≥n recomendada mientras se realizan compresiones tor√°cicas continuas?", options: ["10 ventilaciones por minuto sin interrumpir compresiones.", "30 compresiones por 2 ventilaciones.", "6 ventilaciones por minuto.", "Una ventilaci√≥n cada 10 segundos."], correct: 0 },
            { question: "Durante la RCP, despu√©s de 2 minutos de compresiones y una dosis de adrenalina, se detecta actividad el√©ctrica sin pulso (AESP). ¬øCu√°l es el siguiente paso indicado?", options: ["Administrar una descarga el√©ctrica.", "Continuar RCP y buscar causas reversibles (Hs y Ts).", "Repetir la adrenalina inmediatamente.", "Suspender RCP si hay ritmo."], correct: 1 },
            { question: "¬øCu√°l es el objetivo de mantener una buena calidad de compresiones tor√°cicas durante la RCP avanzada?", options: ["Evitar hipoxia celular y aumentar la perfusi√≥n cerebral y coronaria.", "Aumentar la frecuencia card√≠aca espont√°nea.", "Reducir el dolor en el t√≥rax del paciente.", "Respuesta estimuladora adren√©rgica de los pulmones."], correct: 0 }
        ];

        const allScreens = document.querySelectorAll('.screen'); const welcomeScreen = document.getElementById('welcome-screen'); const gameScreenWrapper = document.getElementById('game-screen-wrapper'); const endScreen = document.getElementById('end-screen'); const registerForm = document.getElementById('register-form'); const restartBtn = document.getElementById('restart-btn'); const livesDisplay = document.getElementById('lives-display'); const levelTitle = document.getElementById('level-title'); const questionBox = document.getElementById('question-box'); const optionsGrid = document.getElementById('options-grid'); const prizeList = document.getElementById('prize-list'); const endMessage = document.getElementById('end-message'); const finalScore = document.getElementById('final-score'); const finalRank = document.getElementById('final-rank'); const leaderboardList = document.getElementById('leaderboard-list'); const backgroundMusic = document.getElementById('background-music'); const questionStartSound = document.getElementById('question-start-sound');
        let gameLevels = [], lastQuestionObject = null, currentQuestionObject = {};
        let currentLevel = 0, lives = 3, totalScore = 0, selectedAnswer = false;
        let currentPlayerName = '', currentPlayerService = '';
        function playSound(sound){try { sound.currentTime=0; sound.play(); } catch (e) { console.error("Error al reproducir sonido:", e); }}
        function stopAllSounds(){document.querySelectorAll('audio').forEach(sound=>{sound.pause();sound.currentTime=0;});}
        function switchScreen(activeScreen){allScreens.forEach(screen=>screen.classList.remove('active'));activeScreen.classList.add('active');}
        function init() { const startOverlay = document.getElementById('start-overlay'); const introVideo = document.getElementById('intro-video'); startOverlay.addEventListener('click', () => { startOverlay.style.display = 'none'; introVideo.muted = false; introVideo.play(); }); introVideo.addEventListener('ended', () => switchScreen(welcomeScreen)); introVideo.addEventListener('error', () => switchScreen(welcomeScreen)); registerForm.addEventListener('submit', handleRegisterSubmit); restartBtn.addEventListener('click', resetGame); }
        function resetGame() { currentLevel=0; lives=3; totalScore=0; gameLevels=[]; lastQuestionObject=null; document.getElementById('player-name').value=''; document.getElementById('player-service').value=''; const startBtn=document.getElementById('start-btn'); startBtn.disabled=false; startBtn.textContent='¬°Comenzar a Jugar!'; switchScreen(welcomeScreen); }
        function handleRegisterSubmit(e) { e.preventDefault(); currentPlayerName=document.getElementById('player-name').value; currentPlayerService=document.getElementById('player-service').value; if (!currentPlayerName||!currentPlayerService){alert("Por favor, completa tu nombre y servicio.");return;} const startBtn=document.getElementById('start-btn'); startBtn.disabled=true; startBtn.textContent='Cargando...'; startGame(); }
        
        // ======================================================================================
        // === L√ìGICA DE JUEGO MODIFICADA PARA 8 NIVELES ========================================
        // ======================================================================================
        function startGame() {
            stopAllSounds();
            playSound(backgroundMusic);
            const shuffledQuestions=[...FULL_QUESTION_BANK].sort(()=>0.5-Math.random());
            gameLevels=[];
            
            // --> CAMBIO: 8 niveles con 10 preguntas cada uno (total 80)
            const levelDistribution = [10, 10, 10, 10, 10, 10, 10, 10]; 
            for (let i=0; i<8; i++) { 
                gameLevels.push({level:i+1, questions:shuffledQuestions.splice(0,levelDistribution[i])});
            }

            currentLevel=0;
            lives=3;
            totalScore=0;
            selectedAnswer=false;
            lastQuestionObject=null;
            prizeList.innerHTML='';
            gameLevels.forEach((levelData)=>{const li=document.createElement('li');li.id=`level-${levelData.level-1}`;li.innerHTML=`<span>${levelData.level}</span> NIVEL ${levelData.level}`;prizeList.appendChild(li);});
            switchScreen(gameScreenWrapper);
            loadQuestion();
        }

        function loadQuestion() { if (currentLevel>=gameLevels.length){winGame();return;} playSound(questionStartSound); selectedAnswer=false; updateHUD(); const levelData=gameLevels[currentLevel]; let availableQuestions=levelData.questions; if(lastQuestionObject&&availableQuestions.length>1){availableQuestions=availableQuestions.filter(q=>q.question!==lastQuestionObject.question);} const questionIndex=Math.floor(Math.random()*availableQuestions.length); currentQuestionObject=availableQuestions[questionIndex]; questionBox.innerText=currentQuestionObject.question; optionsGrid.innerHTML=""; const prefixes=['A','B','C','D']; currentQuestionObject.options.forEach((option,index)=>{const button=document.createElement('button');button.classList.add('option-box');button.innerHTML=`<span class="option-prefix">${prefixes[index]}:</span> ${option}`;button.addEventListener('click',()=>selectAnswer(index,button));optionsGrid.appendChild(button);}); }
        function selectAnswer(selectedIndex,button) { if(selectedAnswer)return; selectedAnswer=true; if(backgroundMusic)backgroundMusic.volume=0.3; const buttons=optionsGrid.getElementsByTagName('button'); button.classList.add('selected'); setTimeout(()=>{ if(backgroundMusic)backgroundMusic.volume=1.0; if(selectedIndex===currentQuestionObject.correct){ playSound(document.getElementById('correct-sound')); button.classList.remove('selected'); button.classList.add('correct'); totalScore++; currentLevel++; lastQuestionObject=null; setTimeout(loadQuestion,1800); } else { playSound(document.getElementById('incorrect-sound')); lives--; lastQuestionObject=currentQuestionObject; button.classList.remove('selected'); button.classList.add('incorrect'); buttons[currentQuestionObject.correct].classList.add('correct'); setTimeout(()=>{if(lives<=0){endGame();}else{loadQuestion();}},2500); } },2000); }
        function updateHUD() { livesDisplay.innerHTML='Intentos: '+'‚ù§Ô∏è'.repeat(lives); levelTitle.innerText=`NIVEL ${currentLevel+1}`; const prizeItems=prizeList.getElementsByTagName('li'); for(let i=0;i<prizeItems.length;i++){prizeItems[i].classList.remove('current');} if(currentLevel<gameLevels.length){document.getElementById(`level-${currentLevel}`).classList.add('current');} }
        function winGame() { handleGameEnd(true); }
        function endGame() { handleGameEnd(false); }

        // ======================================================================================
        // === L√ìGICA DE CONEXI√ìN SIMPLIFICADA Y ROBUSTA (sin cambios) ==========================
        // ======================================================================================
        async function handleGameEnd(isWinner) {
            stopAllSounds();
            endMessage.textContent = isWinner ? "¬°FELICIDADES, HAS GANADO!" : "¬°JUEGO TERMINADO!";
            finalScore.innerText = `Tu puntaje final es: ${totalScore} Puntos`;
            finalRank.textContent = '';
            leaderboardList.innerHTML = "<li>Guardando tu puntaje y actualizando el ranking...</li>";
            switchScreen(endScreen);

            if (isWinner && typeof confetti === 'function') {
                const duration = 2 * 1000; const end = Date.now() + duration;
                (function frame() {
                    confetti({particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }});
                    confetti({particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }});
                    if (Date.now() < end) { requestAnimationFrame(frame); }
                }());
            }

            const newScoreEntry = { name: currentPlayerName, service: currentPlayerService, score: totalScore, id: Date.now() };

            try {
                // Hacemos UNA SOLA LLAMADA: enviamos el puntaje y recibimos el ranking actualizado.
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(newScoreEntry),
                });

                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.statusText}`);
                }

                // La respuesta ya contiene el ranking completo.
                const fullLog = await response.json();
                
                // Si el servidor devolvi√≥ un error en el JSON, lo mostramos.
                if(fullLog.status === 'error'){
                    throw new Error(`Error en el script de Google: ${fullLog.message}`);
                }
                
                displayLeaderboard(fullLog, newScoreEntry.id);

            } catch (error) {
                console.error("Error detallado al conectar con el ranking:", error);
                leaderboardList.innerHTML = `<li>Hubo un error al conectar con el ranking. Revisa la consola (F12) para m√°s detalles.</li>`;
            }
        }
        
        // La funci√≥n de mostrar el ranking no cambia.
        function displayLeaderboard(fullLog, currentPlayerId) {
            leaderboardList.innerHTML = "";
            const sortedFullLog = [...fullLog].sort((a, b) => b.score - a.score);
            const leaderboardData = sortedFullLog.slice(0, 10);

            if (leaderboardData.length === 0) {
                leaderboardList.innerHTML = "<li>A√∫n no hay puntajes. ¬°S√© el primero!</li>";
                finalRank.textContent = "¬°Felicitaciones por ser el primero en jugar!";
                return;
            }

            const playerIndex = sortedFullLog.findIndex(score => score.id === currentPlayerId);
            
            if (playerIndex !== -1) {
                const rank = playerIndex + 1;
                finalRank.textContent = `¬°Felicidades! Lograste el puesto #${rank}.`;
            } else {
                finalRank.textContent = "¬°Buen intento! Sigue jugando para entrar al Top 10.";
            }
            
            leaderboardData.forEach((score, index) => {
                const li = document.createElement('li');
                const scoreText = `${score.score} Puntos`;
                li.innerHTML = `<span>#${index + 1} ${score.name} (${score.service || 'N/A'})</span><span>${scoreText}</span>`;
                if (score.id === currentPlayerId) {
                    li.classList.add('current-player');
                }
                leaderboardList.appendChild(li);
            });
        }

        init();
    </script>
</body>
</html>
