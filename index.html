<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qui√©n Quiere Ser Enfermero</title>
    <!-- Script para la animaci√≥n de confeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* (El CSS es el mismo, se omite por brevedad pero debe estar aqu√≠) */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500&display=swap');
        :root{--main-blue:#02022d;--dark-blue:#0c0c4c;--light-blue:#1e3a8a;--gold:#ffd700;--orange-select:#f9a825;--green-correct:#28a745;--red-incorrect:#dc3545;}body{font-family:'Roboto',sans-serif;margin:0;padding:0;background:radial-gradient(circle, var(--light-blue) 0%, var(--main-blue) 70%);color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow:hidden;}.game-container{width:95%;max-width:1200px;height:90vh;max-height:700px;background:rgba(0,0,0,0.2);border-radius:20px;border:2px solid rgba(255,255,255,0.1);text-align:center;position:relative;}.screen{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity 0.5s ease;background:radial-gradient(circle, var(--light-blue) 0%, var(--main-blue) 70%);z-index:10;}.screen.active{opacity:1;visibility:visible;}#intro-screen{z-index:20;}#intro-logo{width:80%;max-width:500px;animation:zoomInFade 3.5s forwards;}@keyframes zoomInFade{0%{transform:scale(0.5);opacity:0;}20%{transform:scale(1.1);opacity:1;}100%{transform:scale(1);opacity:1;}}#welcome-screen h1,#end-screen h2{font-family:'Orbitron',sans-serif;font-size:3rem;color:var(--gold);text-shadow:0 0 10px var(--gold);z-index:1;}#welcome-screen h1 span{display:block;}.btn{font-family:'Orbitron',sans-serif;background:linear-gradient(135deg, var(--gold), var(--orange-select));color:var(--main-blue);border:none;padding:15px 30px;font-size:1.2rem;font-weight:700;border-radius:50px;cursor:pointer;transition:all 0.3s ease;margin-top:20px;box-shadow:0 4px 15px rgba(255,215,0,0.3);z-index:1;}.btn:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 6px 20px rgba(255,215,0,0.5);}.btn:disabled{background:#999;cursor:not-allowed;}#game-screen-wrapper{background:none;}#game-screen{width:100%;height:100%;display:grid;grid-template-columns:1fr 250px;grid-template-rows:100px 1fr;grid-template-areas:"logo prize" "qa   prize";padding:20px;box-sizing:border-box;}#logo-container{grid-area:logo;display:flex;justify-content:center;align-items:center;}#logo-container img{height:100%;width:auto;max-width:100%;object-fit:contain;}#qa-container{grid-area:qa;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;padding-bottom:20px;}#prize-ladder{grid-area:prize;background:rgba(0,0,0,0.4);border-radius:10px;padding:10px;}#prize-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column-reverse;height:100%;}#prize-list li{flex-grow:1;display:flex;align-items:center;padding:0 15px;font-family:'Orbitron',sans-serif;color:rgba(255,255,255,0.7);transition:all 0.3s ease;border-radius:5px;}#prize-list li.current{background-color:var(--orange-select);color:var(--main-blue);font-weight:700;transform:scale(1.1);box-shadow:0 0 15px var(--orange-select);}#prize-list li span:first-child{color:var(--gold);margin-right:15px;}#level-title{font-family:'Orbitron',sans-serif;font-size:1.8rem;color:var(--gold);margin-bottom:10px;text-shadow:0 0 8px var(--gold);}#question-box{width:90%;height:auto;min-height:80px;background:linear-gradient(180deg, var(--main-blue), var(--dark-blue));border:2px solid var(--gold);border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:1.4rem;padding:15px 25px;margin-bottom:20px;clip-path:polygon(0% 50%, 5% 0%, 95% 0%, 100% 50%, 95% 100%, 5% 100%);}#options-grid{width:90%;display:grid;grid-template-columns:1fr 1fr;gap:15px;}.option-box{background:linear-gradient(180deg, var(--main-blue), var(--dark-blue));border:2px solid var(--gold);color:#fff;font-size:1.2rem;border-radius:10px;cursor:pointer;transition:all 0.2s ease;text-align:left;padding:12px 20px;clip-path:polygon(0% 50%, 8% 0%, 92% 0%, 100% 50%, 92% 100%, 8% 100%);}.option-box:hover{background:var(--light-blue);}.option-prefix{color:var(--orange-select);font-family:'Orbitron',sans-serif;margin-right:15px;}.option-box.selected{background:var(--orange-select);color:var(--main-blue);font-weight:bold;animation:pulse-select 1.2s infinite;}.option-box.correct{background:var(--green-correct);animation:flash-correct 1s;}.option-box.incorrect{background:var(--red-incorrect);animation:shake-incorrect 0.5s;}@keyframes pulse-select{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}@keyframes flash-correct{0%,100%{opacity:1;}50%{opacity:0.3;}}@keyframes shake-incorrect{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-8px);}20%,40%,60%,80%{transform:translateX(8px);}}#lives-display{position:absolute;top:20px;left:20px;font-size:1.5rem;font-family:'Orbitron';}#lives-display span{font-size:2rem;margin-left:5px;color:var(--red-incorrect);text-shadow:0 0 5px var(--red-incorrect);}#welcome-screen form{width:90%;max-width:500px;}.welcome-input{display:block;width:100%;box-sizing:border-box;margin:15px auto;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:1rem;}#leaderboard-container{margin-top:20px;width:90%;max-width:600px;text-align:left;}#leaderboard-list{list-style:none;padding:0;}#leaderboard-list li{background:rgba(0,0,0,0.3);padding:10px 15px;border-radius:5px;margin-bottom:8px;display:flex;justify-content:space-between;font-weight:500;}#leaderboard-list li.current-player{background:var(--gold);color:var(--main-blue);font-weight:700;}#final-rank{font-size:1.3rem;color:var(--gold);margin-top:5px;font-weight:700;}
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Pantallas y HTML -->
        <div id="intro-screen" class="screen active"><img id="intro-logo" src="https://somnozzz.cl/wp-content/uploads/2025/06/ChatGPT-Image-21-jun-2025-00_18_03.png" alt="Logo"></div>
        <div id="welcome-screen" class="screen"><h1>QUI√âN QUIERE SER<br><span>ENFERMERO</span></h1><p>Ingresa tus datos para comenzar. Tienes 3 intentos.</p><form id="register-form"><input type="text" id="player-name" class="welcome-input" placeholder="Tu Nombre y Apellido" required><input type="text" id="player-service" class="welcome-input" placeholder="Tu Servicio / √Årea de Trabajo" required><button type="submit" id="start-btn" class="btn">¬°Comenzar a Jugar!</button></form></div>
        <div id="game-screen-wrapper" class="screen"><div id="lives-display"></div><div id="game-screen"><div id="logo-container"><img src="https://somnozzz.cl/wp-content/uploads/2025/06/ChatGPT-Image-21-jun-2025-00_18_03.png" alt="Logo del Juego"></div><div id="qa-container"><h2 id="level-title"></h2><div id="question-box"></div><div id="options-grid"></div></div><div id="prize-ladder"><ol id="prize-list" reversed></ol></div></div></div>
        
        <!-- PANTALLA FINAL LIMPIA -->
        <div id="end-screen" class="screen">
            <h2 id="end-message"></h2>
            <p id="final-score"></p>
            <p id="final-rank"></p>
            <div id="leaderboard-container">
                <h2>üèÜ Top 10 Jugadores üèÜ</h2>
                <ol id="leaderboard-list"></ol>
                <button id="restart-btn" class="btn">Jugar de Nuevo</button>
            </div>
        </div>
    </div>
    <!-- Contenedores de Audio -->
    <audio id="intro-sound" src="https://somnozzz.cl/wp-content/uploads/2025/06/Pregunta-Quien-quiere-ser-millonario_-Sound-Effect.mp3" preload="auto"></audio><audio id="question-start-sound" src="https://www.myinstants.com/media/sounds/empezar-pregunta-quien-quiere-ser-millonario.mp3" preload="auto"></audio><audio id="background-music" src="https://somnozzz.cl/wp-content/uploads/2025/06/Quien-Quiere-Ser-Millonario-Efecto-de-Sonido.mp3" preload="auto" loop></audio><audio id="correct-sound" src="https://www.myinstants.com/media/sounds/es-correcto.mp3" preload="auto"></audio><audio id="incorrect-sound" src="https://www.myinstants.com/media/sounds/sonido-de-error-de-windows-xp-fatal-error.mp3" preload="auto"></audio>

    <script>
        // --> IMPORTANTE: Pega aqu√≠ la URL que obtuviste de jsonbase.com
        const LEADERBOARD_API_URL = "PEGA_AQUI_TU_URL_DE_JSONBASE";

        // --> Banco de preguntas
        const FULL_QUESTION_BANK = [
            { question: "Proporci√≥n m√°x. recomendada cat√©ter/vena para minimizar trombosis:", options: ["25%", "33%", "50%", "75%"], correct: 1 },
            { question: "¬øCu√°l de estos f√°rmacos de alto riesgo requiere doble chequeo IV?", options: ["Paracetamol", "Enoxaparina", "Insulina", "Omeprazol"], correct: 2 },
            { question: "Caracter√≠stica t√≠pica de la fibrilaci√≥n auricular en un ECG:", options: ["Ondas P regulares", "Intervalo PR constante", "Ritmo irregularmente irregular", "Complejos QRS anchos"], correct: 2 },
            { question: "Sitio anat√≥mico preferente para inserci√≥n de sonda vesical en adultos:", options: ["Meato uretral", "Fosa il√≠aca derecha", "L√≠nea media infraumbilical", "Perin√© posterior"], correct: 0 },
            { question: "Vacuna PNI chileno que se administra a los 2, 4 y 6 meses:", options: ["SRP", "BCG", "Hexavalente", "Influenza"], correct: 2 },
            { question: "¬øCu√°l medida corresponde a una precauci√≥n est√°ndar?", options: ["Uso de N95 por TBC", "Guantes al contacto con fluidos", "Aislamiento por contacto", "Habitaci√≥n presi√≥n negativa"], correct: 1 },
            { question: "En sistema ESI, ¬øqu√© nivel requiere intervenci√≥n inmediata y m√∫ltiples recursos?", options: ["ESI 1", "ESI 2", "ESI 3", "ESI 5"], correct: 1 },
            { question: "Principio de la estrategia ‚ÄúHospital Amigo‚Äù en Chile:", options: ["Ingreso restringido de familia", "Rotaci√≥n frecuente de personal", "Participaci√≥n del paciente y familia", "Entrega diferida de info"], correct: 2 },
            { question: "Seg√∫n Ley de Urgencia, ¬øqu√© debe hacer un hospital ante urgencia vital?", options: ["Derivar de inmediato", "Esperar confirmaci√≥n previsi√≥n", "Estabilizar sin autorizaci√≥n", "Solicitar pago anticipado"], correct: 2 },
            { question: "¬øQu√© grupo de pacientes est√° cubierto por la Ley MILA?", options: ["Adultos mayores cr√≥nicos", "Trabajadores con riesgo laboral", "Ni√±os con enf. graves", "Embarazadas sin previsi√≥n"], correct: 2 },
            { question: "En acreditaci√≥n hospitalaria, ¬øqu√© significa ‚Äútrazabilidad‚Äù?", options: ["Rotaci√≥n de turnos", "Control de inventario", "Registro verificable de atenci√≥n", "Pacientes por turno"], correct: 2 },
            { question: "D√≠as de inasistencia injustificada para abandono de funciones (Estatuto Adm.):", options: ["3 d√≠as", "5 d√≠as", "7 d√≠as", "10 d√≠as"], correct: 1 },
            { question: "Seg√∫n Ley Karin, ¬øqu√© conducta se considera acoso laboral?", options: ["Evaluaci√≥n de desempe√±o", "Exigir puntualidad", "Hostigamiento sistem√°tico", "Reasignaci√≥n de funciones"], correct: 2 },
            { question: "En sistema CUDYR, ¬øqu√© dimensi√≥n eval√∫a el compromiso neurol√≥gico?", options: ["Hemodin√°mica", "Conductual", "Conciencia", "Examen f√≠sico"], correct: 2 },
            { question: "Tiempo m√°x. recomendado para uso de sistema de infusi√≥n continua cerrado:", options: ["24 horas", "48 horas", "72 horas", "96 horas"], correct: 3 },
            { question: "F√°rmaco con pH 4.5, osmolaridad 800 mOsm/L, terapia >7 d√≠as, ¬øqu√© acceso requiere?", options: ["VVP", "L√≠nea media", "PICC o v√≠a central", "Cat√©ter subcut√°neo"], correct: 2 },
            { question: "¬øCu√°l de estas combinaciones de f√°rmacos NO es compatible en Y-site?", options: ["Furosemida y NaCl 0.9%", "Dopamina y Heparina", "Vancomicina y Ranitidina", "Fentanilo y Midazolam"], correct: 2 },
            { question: "Caracter√≠stica de un bloqueo AV de segundo grado Mobitz II:", options: ["PR se alarga y omite QRS", "PR constante, QRS omitido", "PR variable, P y QRS sin relaci√≥n", "Taquicardia ventricular"], correct: 1 },
            { question: "Acci√≥n fundamental al programar bomba de infusi√≥n con f√°rmacos vasoactivos:", options: ["Usar equipos de gravedad", "Conectar a cat√©ter SC", "Doble chequeo", "Administrar IM"], correct: 2 },
            { question: "Conducta inmediata ante un ESAVI grave:", options: ["Dar paracetamol y alta", "Notificar al MINSAL sin evaluar", "Activar protocolo y evaluar", "Repetir vacuna para confirmar"], correct: 2 }
        ];

        // --- ELEMENTOS DEL DOM ---
        const allScreens = document.querySelectorAll('.screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const gameScreenWrapper = document.getElementById('game-screen-wrapper');
        const endScreen = document.getElementById('end-screen');
        const registerForm = document.getElementById('register-form');
        const restartBtn = document.getElementById('restart-btn');
        const livesDisplay = document.getElementById('lives-display');
        const levelTitle = document.getElementById('level-title');
        const questionBox = document.getElementById('question-box');
        const optionsGrid = document.getElementById('options-grid');
        const prizeList = document.getElementById('prize-list');
        const endMessage = document.getElementById('end-message');
        const finalScore = document.getElementById('final-score');
        const finalRank = document.getElementById('final-rank');
        const leaderboardList = document.getElementById('leaderboard-list');
        const backgroundMusic = document.getElementById('background-music');
        const questionStartSound = document.getElementById('question-start-sound');

        // --- ESTADO DEL JUEGO ---
        let gameLevels = [], lastQuestionObject = null, currentQuestionObject = {};
        let currentLevel = 0, lives = 3, totalScore = 0, selectedAnswer = false;
        let currentPlayerName = '', currentPlayerService = '';

        // --- L√ìGICA DE API Y SONIDO ---
        async function getLeaderboardFromAPI(){try{const response=await fetch(LEADERBOARD_API_URL);if(!response.ok)return[];const data=await response.json();return Array.isArray(data)?data:[];}catch(error){console.error("Error al obtener el ranking:",error);return[];}}
        
        // --> FUNCI√ìN DE ACTUALIZACI√ìN CORREGIDA Y M√ÅS ROBUSTA
        async function updateLeaderboardAPI(newScore) {
            let leaderboard = await getLeaderboardFromAPI();
            leaderboard.push(newScore);
            leaderboard.sort((a, b) => b.score - a.score);
            const top10 = leaderboard.slice(0, 10);

            // Si la URL no est√° configurada, la funci√≥n no intentar√° guardar online,
            // pero devolver√° la lista actualizada para que se muestre localmente.
            if (LEADERBOARD_API_URL === "PEGA_AQUI_TU_URL_DE_JSONBASE") {
                console.warn("La URL de la API no est√° configurada. El ranking se mostrar√° pero no se guardar√° online.");
                return top10;
            }

            try {
                await fetch(LEADERBOARD_API_URL, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(top10)});
                return top10;
            } catch (error) {
                console.error("Error al actualizar el ranking:", error);
                return top10; // Devuelve la lista local incluso si falla el guardado.
            }
        }
        
        function playSound(sound){try { sound.currentTime=0; sound.play(); } catch (e) { console.error("Error al reproducir sonido:", e); }}
        function stopAllSounds(){document.querySelectorAll('audio').forEach(sound=>{sound.pause();sound.currentTime=0;});}
        function switchScreen(activeScreen){allScreens.forEach(screen=>screen.classList.remove('active'));activeScreen.classList.add('active');}
        
        // --- INICIALIZACI√ìN ---
        function init() {
            setTimeout(() => switchScreen(welcomeScreen), 3500);
            registerForm.addEventListener('submit', handleRegisterSubmit);
            restartBtn.addEventListener('click', resetGame);
        }

        function resetGame() {
            currentLevel=0; lives=3; totalScore=0; gameLevels=[]; lastQuestionObject=null;
            document.getElementById('player-name').value='';
            document.getElementById('player-service').value='';
            const startBtn=document.getElementById('start-btn'); startBtn.disabled=false; startBtn.textContent='¬°Comenzar a Jugar!';
            switchScreen(welcomeScreen);
        }
        
        function handleRegisterSubmit(e) {
            e.preventDefault();
            currentPlayerName=document.getElementById('player-name').value;
            currentPlayerService=document.getElementById('player-service').value;
            if (!currentPlayerName||!currentPlayerService){alert("Por favor, completa tu nombre y servicio.");return;}
            const startBtn=document.getElementById('start-btn'); startBtn.disabled=true; startBtn.textContent='Cargando...';
            startGame();
        }

        function startGame() {
            stopAllSounds(); playSound(backgroundMusic);
            const shuffledQuestions=[...FULL_QUESTION_BANK].sort(()=>0.5-Math.random());
            gameLevels=[]; const questionsPerLevel=4;
            for (let i=0; i<5; i++) {
                gameLevels.push({level:i+1, questions:shuffledQuestions.splice(0,questionsPerLevel)});
            }
            currentLevel=0; lives=3; totalScore=0; selectedAnswer=false; lastQuestionObject=null;
            prizeList.innerHTML='';
            gameLevels.forEach((levelData)=>{const li=document.createElement('li');li.id=`level-${levelData.level-1}`;li.innerHTML=`<span>${levelData.level}</span> NIVEL ${levelData.level}`;prizeList.appendChild(li);});
            switchScreen(gameScreenWrapper); loadQuestion();
        }

        function loadQuestion() {
            if (currentLevel>=gameLevels.length){winGame();return;}
            playSound(questionStartSound); selectedAnswer=false; updateHUD();
            const levelData=gameLevels[currentLevel];
            let availableQuestions=levelData.questions;
            if(lastQuestionObject&&availableQuestions.length>1){availableQuestions=availableQuestions.filter(q=>q.question!==lastQuestionObject.question);}
            const questionIndex=Math.floor(Math.random()*availableQuestions.length);
            currentQuestionObject=availableQuestions[questionIndex];
            questionBox.innerText=currentQuestionObject.question; optionsGrid.innerHTML="";
            const prefixes=['A','B','C','D'];
            currentQuestionObject.options.forEach((option,index)=>{const button=document.createElement('button');button.classList.add('option-box');button.innerHTML=`<span class="option-prefix">${prefixes[index]}:</span> ${option}`;button.addEventListener('click',()=>selectAnswer(index,button));optionsGrid.appendChild(button);});
        }

        function selectAnswer(selectedIndex,button) {
            if(selectedAnswer)return; selectedAnswer=true;
            if(backgroundMusic)backgroundMusic.volume=0.3;
            const buttons=optionsGrid.getElementsByTagName('button'); button.classList.add('selected');
            setTimeout(()=>{
                if(backgroundMusic)backgroundMusic.volume=1.0;
                if(selectedIndex===currentQuestionObject.correct){
                    playSound(document.getElementById('correct-sound')); button.classList.remove('selected'); button.classList.add('correct');
                    totalScore++; currentLevel++; lastQuestionObject=null;
                    setTimeout(loadQuestion,1800);
                } else {
                    playSound(document.getElementById('incorrect-sound')); lives--; lastQuestionObject=currentQuestionObject;
                    button.classList.remove('selected'); button.classList.add('incorrect');
                    buttons[currentQuestionObject.correct].classList.add('correct');
                    setTimeout(()=>{if(lives<=0){endGame();}else{loadQuestion();}},2500);
                }
            },2000);
        }

        function updateHUD() {
            livesDisplay.innerHTML='Intentos: '+'‚ù§Ô∏è'.repeat(lives);
            levelTitle.innerText=`NIVEL ${currentLevel+1}`;
            const prizeItems=prizeList.getElementsByTagName('li');
            for(let i=0;i<prizeItems.length;i++){prizeItems[i].classList.remove('current');}
            if(currentLevel<gameLevels.length){document.getElementById(`level-${currentLevel}`).classList.add('current');}
        }
        
        async function handleGameEnd(isWinner) {
            stopAllSounds();
            endMessage.textContent = isWinner ? "¬°FELICIDADES, HAS GANADO!" : "¬°JUEGO TERMINADO!";
            finalScore.innerText = `Tu puntaje final es: ${totalScore} Puntos`;
            finalRank.textContent = '';
            leaderboardList.innerHTML = "<li>Cargando ranking...</li>";
            switchScreen(endScreen);

            if (typeof confetti === 'function') {
                const duration = 2 * 1000; const end = Date.now() + duration;
                (function frame() {
                    confetti({particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }});
                    confetti({particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }});
                    if (Date.now() < end) { requestAnimationFrame(frame); }
                }());
            }

            const newScoreEntry = { name: currentPlayerName, service: currentPlayerService, score: totalScore, id: Date.now() };
            const finalLeaderboard = await updateLeaderboardAPI(newScoreEntry);
            displayLeaderboard(finalLeaderboard, newScoreEntry.id);
        }

        function winGame() { handleGameEnd(true); }
        function endGame() { handleGameEnd(false); }
        
        function displayLeaderboard(leaderboardData, currentPlayerId) {
            leaderboardList.innerHTML = "";
            if (!leaderboardData || leaderboardData.length === 0) {
                leaderboardList.innerHTML = "<li>A√∫n no hay puntajes. ¬°S√© el primero!</li>";
                finalRank.textContent = "¬°Felicitaciones por ser el pionero!";
                return;
            }

            const playerIndex = leaderboardData.findIndex(score => score.id === currentPlayerId);
            if (playerIndex !== -1) {
                const rank = playerIndex + 1;
                finalRank.textContent = `¬°Lograste el puesto #${rank} en el Top 10!`;
            } else {
                finalRank.textContent = "¬°Sigue intentando para entrar al Top 10!";
            }
            
            leaderboardData.forEach((score, index) => {
                const li = document.createElement('li');
                const scoreText = `${score.score} Puntos`;
                li.innerHTML = `<span>#${index + 1} ${score.name} (${score.service})</span><span>${scoreText}</span>`;
                if (score.id === currentPlayerId) {
                    li.classList.add('current-player');
                }
                leaderboardList.appendChild(li);
            });
        }

        init();
    </script>
</body>
</html>
